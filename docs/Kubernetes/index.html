<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Kubernetes/Kubernetes">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Kubernetes | 知行合一</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://iewiewiew.github.io/img/me.jpeg"><meta data-rh="true" name="twitter:image" content="https://iewiewiew.github.io/img/me.jpeg"><meta data-rh="true" property="og:url" content="https://iewiewiew.github.io/docs/Kubernetes/"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kubernetes | 知行合一"><meta data-rh="true" name="description" content="[TOC]"><meta data-rh="true" property="og:description" content="[TOC]"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://iewiewiew.github.io/docs/Kubernetes/"><link data-rh="true" rel="alternate" href="https://iewiewiew.github.io/docs/Kubernetes/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://iewiewiew.github.io/docs/Kubernetes/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.183e182e.css">
<link rel="preload" href="/assets/js/runtime~main.5e310ca4.js" as="script">
<link rel="preload" href="/assets/js/main.cb284e89.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/me.jpeg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/me.jpeg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">wei</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">目录</a><a href="https://www.processon.com/mindmap/6138112f1e085306ef9fe608" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">技能图谱<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/iewiewiew" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">README</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/AI/">AI</a><button aria-label="打开/收起侧边栏菜单「AI」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Ansible/">Ansible</a><button aria-label="打开/收起侧边栏菜单「Ansible」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/CSBasic/Network">CSBasic</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Chaos/ChaosBlade">Chaos</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Database/ClickHouse/">Database</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/DevOps/">DevOps</a><button aria-label="打开/收起侧边栏菜单「DevOps」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Docker/">Docker</a><button aria-label="打开/收起侧边栏菜单「Docker」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Git/">Git</a><button aria-label="打开/收起侧边栏菜单「Git」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/JMeter/">JMeter</a><button aria-label="打开/收起侧边栏菜单「JMeter」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Jenkins/">Jenkins</a><button aria-label="打开/收起侧边栏菜单「Jenkins」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible menu__list-item-collapsible--active"><a class="menu__link menu__link--sublist menu__link--active" aria-current="page" aria-expanded="true" href="/docs/Kubernetes/">Kubernetes</a><button aria-label="打开/收起侧边栏菜单「Kubernetes」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Kubernetes/Helm">Helm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Kubernetes/Helm_Install">Helm_Install</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Kubernetes/Kubernetes_Install">Kubernetes_Install</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Kubernetes/Kubernetes_Lite">Kubernetes_Lite</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Kubernetes/Kubernetes_Other">Kubernetes_Other</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Linux/">Linux</a><button aria-label="打开/收起侧边栏菜单「Linux」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Middleware/Apollo/">Middleware</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Mixinfo/BigData/大数据">Mixinfo</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/SoftwareTest/AppTest">SoftwareTest</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Kubernetes</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Kubernetes</h1></header><p>[TOC]</p><h1 align="center">Kubernetes</h1><blockquote><p>By：weimenghua<br>
<!-- -->Date：2022.10.01<br>
<!-- -->Description：Kubernetes 容器编排</p></blockquote><p><strong>参考资料</strong><br>
<a href="https://www.kubernetes.org.cn/" target="_blank" rel="noopener noreferrer">Kubernetes 中文社区</a><br>
<a href="http://docs.kubernetes.org.cn/" target="_blank" rel="noopener noreferrer">Kubernetes 中文文档</a><br>
<a href="https://kubernetes.io/zh-cn/docs/tutorials/" target="_blank" rel="noopener noreferrer">Kubernetes 官方教程</a><br>
<a href="https://gitee.com/yooome/golang" target="_blank" rel="noopener noreferrer">Kubernetes 详细教程</a><br>
<a href="https://kuboard.cn/learning/" target="_blank" rel="noopener noreferrer">kuboard 教程</a><br>
<a href="https://www.kubebiz.com/" target="_blank" rel="noopener noreferrer">kubebiz 软件列表</a><br>
<a href="https://developer.aliyun.com/mirror/" target="_blank" rel="noopener noreferrer">阿里云官方镜像站</a><br>
<a href="https://www.yuque.com/coolops/kubernetes" target="_blank" rel="noopener noreferrer">kubernetes 语雀</a></p><h1>1. Kubernetes 入门</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-kubernetes-简介">1.1 Kubernetes 简介<a href="#11-kubernetes-简介" class="hash-link" aria-label="1.1 Kubernetes 简介的直接链接" title="1.1 Kubernetes 简介的直接链接">​</a></h2><p><strong>1.1.1 简介</strong></p><p>Kubernetes 是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。</p><p>通过 Kubernetes 可以：</p><ul><li>快速部署应用</li><li>快速扩展应用</li><li>无缝对接新的应用功能</li><li>节省资源，优化硬件资源的使用</li></ul><p>Kubernetes 的全生命周期管理：创建集群，部署应用，发布应用，扩展应用，更新应用。
Kubernetes 是Google 2014年创建管理的，是 Google 10多年大规模容器管理技术 Borg 的开源版本。</p><p><strong>1.1.2 特点</strong></p><ul><li>可移植: 支持公有云，私有云，混合云，多重云（multi-cloud）</li><li>可扩展: 模块化, 插件化，可挂载，可组合</li><li>自动化: 自动部署，自动重启，自动复制，自动伸缩/扩展</li></ul><p><strong>1.1.3 优势</strong></p><p>容器优势总结：</p><ul><li>快速创建/部署应用：与 VM 虚拟机相比，容器镜像的创建更加容易。</li><li>持续开发、集成和部署：提供可靠且频繁的容器镜像构建/部署，并使用快速和简单的回滚(由于镜像不可变性)。</li><li>开发和运行相分离：在 build 或者 release 阶段创建容器镜像，使得应用和基础设施解耦。</li><li>开发，测试和生产环境一致性：在本地或外网（生产环境）运行的一致性。</li><li>云平台或其他操作系统：可以在 Ubuntu、RHEL、 CoreOS、on-prem、Google Container Engine 或其它任何环境中运行。</li><li>Loosely coupled，分布式，弹性，微服务化：应用程序分为更小的、独立的部件，可以动态部署和管理。</li><li>资源隔离。</li><li>资源利用：更高效。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-kubernetes-组件">1.2 Kubernetes 组件<a href="#12-kubernetes-组件" class="hash-link" aria-label="1.2 Kubernetes 组件的直接链接" title="1.2 Kubernetes 组件的直接链接">​</a></h2><p><strong>1.2.1 组件</strong>
一个 Kubernetes 集群包含两种类型的资源:</p><ul><li>Master 负责管理整个集群。 Master 协调集群中的所有活动，例如调度应用、维护应用的所需状态、应用扩容以及推出新的更新。</li><li>Node 负责运行应用。是一个虚拟机或者物理机，它在 Kubernetes 集群中充当工作机器的角色 每个 Node 都有 Kubelet , 它管理 Node，而且是 Node 与 Master 通信的代理。 Node 还应该具有用于处理容器操作的工具，例如 Docker 或 rkt 。处理生产级流量的 Kubernetes 集群至少应具有三个 Node，因为如果一个 Node 出现故障其对应的 etcd 成员和控制平面实例都会丢失，并且冗余会受到影响。 你可以通过添加更多控制平面节点来降低这种风险。</li></ul><ol><li>kubectl：客户端命令行工具，作为整个系统的操作入口。</li><li>kube-apiserver：以 REST API 服务形式提供接口，作为整个系统的控制入口。</li><li>kube-controller-manager：执行整个系统的后台任务，包括节点状态状况、Pod 个数、Pods 和Service 的关联等。</li><li>kube-scheduler：负责节点资源管理，接收来自 kube-apiserver 创建 Pods 任务，并分配到某个节点。</li><li>etcd：负责节点间的服务发现和配置共享。</li><li>kube-proxy：运行在每个计算节点上，负责 Pod 网络代理。定时从 etcd 获取到 service 信息来做相应的策略。</li><li>kubelet：运行在每个计算节点上，作为 agent，接收分配该节点的 Pods 任务及管理容器，周期性获取容器状态，反馈给 kube-apiserver。</li><li>DNS：一个可选的 DNS 服务，用于为每个 Service 对象创建 DNS 记录，这样所有的 Pod 就可以通过 DNS 访问服务了。</li></ol><p><strong>1.2.2 源码</strong>
<a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener noreferrer">kubernetes 源码</a>  </p><ul><li>文档类（api、docs、logo）  </li><li>工具类（build、cluster、Godeps、hack、staging、translations）     </li><li>代码类（cmd、pkg、plugin、test、third_party）        </li></ul><h1>2. Kubernetes 搭建</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-kubernetes-搭建mac">2.1 Kubernetes 搭建（Mac）<a href="#21-kubernetes-搭建mac" class="hash-link" aria-label="2.1 Kubernetes 搭建（Mac）的直接链接" title="2.1 Kubernetes 搭建（Mac）的直接链接">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. 下载 Docker Desktop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://www.docker.com/products/docker-desktop/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 下载 Kubernetes-docker-desktop-for-mac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/gotoKubernetes/Kubernetes-docker-desktop-for-mac.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 进入 Kubernetes-docker-desktop-for-mac 项目，拉取镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./load_images.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 打开 Docker Desktop 配置页面，勾选 enable Kubernetes（时间有点长）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. 在命令终端输入如下命令，验证是否安装成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cluster-info</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-kubernetes-搭建linux">2.2 Kubernetes 搭建（Linux）<a href="#22-kubernetes-搭建linux" class="hash-link" aria-label="2.2 Kubernetes 搭建（Linux）的直接链接" title="2.2 Kubernetes 搭建（Linux）的直接链接">​</a></h2><p>部署 Kubernetes 集群主要有两种方式：</p><ul><li><p>kubeadm：<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/" target="_blank" rel="noopener noreferrer">Kubeadm</a> 是官方社区推出的一个用于快速部署 kubernetes 集群的工具，提供 kubeadm init 和 kubeadm join，用于快速部署 Kubernetes 集群。</p></li><li><p>二进制包：从 github 下载发行版的二进制包，手动部署每个组件，组成 Kubernetes 集群。</p></li></ul><p>以下是通过 kubeadm 安装 Kubernetes 的教程。</p><p><strong>2.2.1 初始化环境</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. 查看操作系统版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：cat /etc/centos-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 关闭防火墙</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">作用：kubernetes 和docker 在运行的中会产生大量的 iptables 规则，为了不让系统规则跟它们混淆，直接关闭系统的规则。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop firewalld    //暂时关闭防火墙</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl disable firewalld //永久关闭防火墙</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：firewall-cmd --state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop iptables    //暂时关闭 iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl disable iptables //永久关闭 iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：systemctl status iptables / iptables -L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 禁用 selinux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：cat /etc/selinux/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 关闭 swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">作用：swap 分区指的是虚拟内存分区，它的作用是物理内存使用完，之后将磁盘空间虚拟成内存来使用，启用 swap 设备会对系统的性能产生非常负面的影响，因此 kubernetes 要求每个节点都要禁用 swap 设备，但是如果因为某些原因确实不能关闭 swap 分区，就需要在集群安装过程中通过明确的参数进行配置说明。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">swapoff -a                          //暂时关闭 swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab //永久关闭 swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：cat /etc/fstab 或者 free -m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. 时间同步（未操作）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">作用：kubernetes 要求集群中的节点时间必须精确一直，这里使用 chronyd 服务从网络同步时间。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start chronyd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable chronyd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">手动校准：chronyc makestep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看同步状态：chronyc tracking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6. 配置内核参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">作用：将桥接的 IPv4流量传递到 iptables 的链。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; /etc/sysctl.d/Kubernetes.conf &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.bridge.bridge-nf-call-iptables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">刷新配置：sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：cat /etc/sysctl.d/Kubernetes.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7. 添加阿里源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup 或者 rm -rfv /etc/yum.repos.d/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo # 根据系统版本选择</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：cat /etc/yum.repos.d/CentOS-Base.repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8. 配置主机名（替换为主机 ip）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">作用：为了方便集群节点间的直接调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1 k8s-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.2 k8s-node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.3 k8s-node2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：cat /etc/hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9. 其它</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看本机 ip：ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">修改主机名：hostnamectl set-hostname k8s-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">重启主机：reboot</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.2 安装常用包</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. 安装常用包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y vim bash-completion net-tools gcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 使用阿里云源安装 docker-ce（跳过，如果本地没有 Docker 则需执行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y docker-ce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;registry-mirrors&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;https://mirror.ccs.tencentyun.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;exec-opts&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;native.cgroupdriver=systemd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：cat /etc/docker/daemon.json  注：追加写入，注意检查下是否有重复</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.3 安装 kubectl、kubelet、kubeadm</strong>
Kubelet 是负责与其他节点集群通信，并进行本节点 Pod 和容器生命周期的管理。<br>
<!-- -->Kubeadm 是 Kubernetes 的自动化部署工具，降低了部署难度，提高效率。<br>
<!-- -->Kubectl 是 Kubernetes 集群管理工具。  </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. 添加阿里云 kubernetes 源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kubernetes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name=Kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enabled=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpgcheck=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">repo_gpgcheck=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：cat /etc/yum.repos.d/kubernetes.repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">踩坑：如果无法下载 kubectl、kubelet、kubeadm，修改 /etc/yum.repos.d/kubernetes.repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果设置 gpgcheck=0 和 repo_gpgcheck=0，则表示禁用了 YUM 对软件包签名的验证，YUM 将不会对软件包的完整性进行验证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpgcheck=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">repo_gpgcheck=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 安装 kubectl、kubelet、kubeadm（踩坑：指定合适的版本，各组件版本一致，以下使用1.23.5版本）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y kubectl kubelet kubeadm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y kubectl-1.23.5 kubelet-1.23.5 kubeadm-1.23.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 开机自启 docker+开机自启 kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 配置 kubelet 的cgroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; /etc/sysconfig/kubelet &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KUBELET_CGROUP_ARGS=&quot;--cgroup-driver=systemd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KUBE_PROXY_MODE=&quot;ipvs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">检查：cat /etc/sysconfig/kubelet  注：追加写入，注意检查下是否有重复</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. 查看版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubelet --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看 kubeadm 的版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum list --showduplicates kubeadm --disableexcludes=kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">升级 kubeadm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y kubeadm-1.18.9-0 --disableexcludes=kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6. 查看镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubeadm config images list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7. 查看 kubelet 配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /var/lib/kubelet/config.yaml |grep group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8. 重启 kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9. 配置 k8s 环境变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot; &gt;&gt; ~/.bash_profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source ~/.bash_profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat ~/.bash_profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10. 卸载 kubectl、kubelet、kubeadm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：yum remove -y kubectl kubelet kubeadm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11. 踩坑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">问题1：kubectl 启动不了？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">解决1：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">修改 Docker 配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim /etc/docker/daemon.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">添加</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;exec-opts&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;native.cgroupdriver=systemd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">重启 Docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart docker  # 即使已经配置也要重启一下</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.4. 初始化 Kubernetes 单节点/集群</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. 初始化 Kubernetes 单节点 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">踩坑：只有单节点，参数无需添加(10.0.12.14 内网 ip) --apiserver-advertise-address=10.0.12.14   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init --kubernetes-version=v1.23.5 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image-repository registry.aliyuncs.com/google_containers  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--service-cidr=10.10.0.0/16 --pod-network-cidr=10.122.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 初始化 Kubernetes 集群</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init --kubernetes-version=v1.23.5 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--apiserver-advertise-address=10.0.12.14   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image-repository registry.aliyuncs.com/google_containers  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--service-cidr=10.10.0.0/16 --pod-network-cidr=10.122.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">–kubernetes-version: 用于指定 Kubernetes 版本(kubeadm config images list 查看的)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">–apiserver-advertise-address：用于指定 kube-apiserver 监听的 ip 地址，就是 master 本机 IP 地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">–pod-network-cidr：用于指定 Pod 的网络范围：10.244.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">–service-cidr：用于指定 SVC 的网络范围</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">–image-repository: 指定阿里云镜像仓库地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看日志：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">journalctl -xeu kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">journalctl -u kubelet --no-pager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">journalctl -f -u kubelet.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">初始化 Kubernetes 之后在/etc/kubernetes 目录下生成配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">杀掉原进程：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：ps -ef|grep process_name|grep -v grep|awk &#x27;{print &quot;kill -9 &quot;$2}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kill -9 `lsof -i:10250 |awk &#x27;{print $2}&#x27; |grep -v PID`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kill -9 `lsof -i:2379 |awk &#x27;{print $2}&#x27; |grep -v PID`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kill -9 `lsof -i:2380 |awk &#x27;{print $2}&#x27; |grep -v PID`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsof -i:6443 |grep -v grep |grep -v PID |awk &#x27;{print &quot;kill -9 &quot;$2}&#x27; |sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsof -i:2379 |grep -v grep |grep -v PID |awk &#x27;{print &quot;kill -9 &quot;$2}&#x27; |sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">删除配置文件：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /etc/kubernetes/manifests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /var/lib/etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 创建 kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p $HOME/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat $HOME/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 使 kubectl 可以自动补充</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source &lt;(kubectl completion bash)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. 查看节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6. node 节点为 NotReady，因为 corednspod 没有启动，缺少网络 pod，安装 calico 网络</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7. 重置配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">踩坑：如果修改配置重启后不生效，就重置再安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm reset</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.5 添加 node 节点</strong>
Node 是Kubernetes 中的工作节点，最开始被称为 minion。一个 Node 可以是 VM 或物理机。每个 Node（节点）具有运行 pod 的一些必要服务，并由 Master 组件进行管理，Node 节点上的服务包括 Docker、kubelet 和kube-proxy。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、添加新节点需要在原 master 节点获取 token 和hash 值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">获取 token（在 master 节点执行），有效期24小时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubeadm token create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">生成永久 token 命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token create --ttl 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token create --ttl 0 --print-join-command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看 token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubeadm token list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、获取 hash 值（在 master 节点执行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#x27;s/^.* //&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、加入集群（在新节点机器上执行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubeadm join $ip:$port --token $token_value --discovery-token-ca-cert-hash  sha256:$hash_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip 为 master 节点 ip 地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port 为 Kubernetes 端口号，通常为6443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token_value 为上面生成的 token 值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hash_value 为上面生成的 hash 值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubeadm join 10.0.12.14:6443 --token l8l9n0.85tm5t1it9g3wrlj \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --discovery-token-ca-cert-hash sha256:8b290723e39c959a899ca6fc532a8a25f80473bbd735c6aab001185ac9caa5f2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、安装网络插件，只在 master 节点操作即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用配置文件启动 fannel：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f kube-flannel.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.5.1 查看 node</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. 查看 node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 查看 node 详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get node -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 查看 node 标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get node --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 查看 node 详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl describe node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. 查看资源占用情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl top node</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.5.2、启 NotReady 节点</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、master 节点直接在对应节点重启 kubelet 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、slave 节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">设置节点为不可调度状态（在 master 节点执行），停止节点后，上面已经运行的工作负载（Pod）不会受到影响，新的工作负载不会调度到该节点上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl cordon &lt;node 节点名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、驱逐节点上 pod（在 master 节点执行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl drain &lt;node 节点名称&gt; --delete-local-data --force --ignore-daemonsets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">参数说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">–delete-local-data: 即使 pod 使用了 emptyDir 也删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">–ignore-daemonsets: 忽略 deamonset 控制器的 pod，如果不忽略，deamonset 控制器控制的 pod 被删除后可能马上又在此节点上启动起来,会成为死循环；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">–force: 不加 force 参数只会删除该 NODE 上由 ReplicationController, ReplicaSet, DaemonSet,StatefulSet or Job 创建的 Pod，加了后还会删除’裸奔的 pod’(没有绑定到任何 replication controller)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、停止 Master 节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">注意顺序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop kubelet </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop etcd </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、如果不想恢复使用，删除节点并确认节点信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete node &lt;node 节点名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、恢复 Master 节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">注意顺序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status docker etcd kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7、重启服务(在对应节点机器上执行)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8、恢复节点为可调度状态（在 master 节点执行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl uncordon &lt;node 节点名称&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.5.3、删除节点</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、驱逐要删除节点上的 pods（master 节点执行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl drain &lt;node 节点名称&gt; --delete-local-data --force --ignore-daemonsets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、执行删除（master 节点执行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl delete node &lt;node 节点名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、在删除的节点机器上执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubeadm reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、清除目录、删除网络设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig cni0 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip link delete cni0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig flannel.1 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip link delete flannel.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm /var/lib/cni/ -rf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm /etc/kubernetes/ -rf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm /var/lib/kubelet/ -rf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、使用 kubeadm reset 重置集群</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 master 节点之外的节点进行操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /var/lib/cni/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /var/lib/kubelet/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /etc/cni/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig cni0 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig flannel.1 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig docker0 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip link delete cni0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip link delete flannel.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">重启 kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">重启 docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.6、重启集群</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">查看信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">停止 Master 节点调度，停止后，上面已经运行的工作负载（Pod）不会受到影响，新的工作负载不会调度到该节点上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cordon k8s-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">再次查看信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">驱逐 Master 节点上的工作负载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-daemonsets 驱逐 pod 时忽略 daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--delete-local-data 驱逐 pod 时删除 pod 的临时数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl drain k8s-master --delete-local-data --ignore-daemonsets --force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看节点上是否还有业务 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod -A -o wide |grep k8s-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">停止 Master 节点, 注意顺序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop kubelet </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop etcd </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果不想恢复使用，删除节点并确认节点信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete node k8s-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">恢复 Master 节点, 注意顺序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status docker etcd kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">允许 Master 节点调度, 取消不可调度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl uncordon k8s-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">待定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">swapoff -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setenforce 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.2.7、知识碎片</strong></p><p>设置别名</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; ~/.bashrc &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alias k=&#x27;kubectl&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alias h=&#x27;helm&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source ~/.bashrc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat ~/.bashrc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>3. Kubernetes 资源</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-资源配置">3.1 资源配置<a href="#31-资源配置" class="hash-link" aria-label="3.1 资源配置的直接链接" title="3.1 资源配置的直接链接">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看某种资源可以配置的一级属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl explain 资源类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl explain pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看属性的子属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl explain 资源类型.属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl explain pod.spec</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-资源管理">3.2 资源管理<a href="#32-资源管理" class="hash-link" aria-label="3.2 资源管理的直接链接" title="3.2 资源管理的直接链接">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、命令式对象管理：直接使用命令去操作 kubernetes 资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run nginx-pod --image=nginx:1.17.1 --port=80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、命令式对象配置：通过命令配置和配置文件去操作 kubernetes 资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create/patch -f nginx-pod.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、声明式对象配置：通过 apply 命令和配置文件去操作 kubernetes 资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f nginx-pod.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-资源类型">3.3 资源类型<a href="#33-资源类型" class="hash-link" aria-label="3.3 资源类型的直接链接" title="3.3 资源类型的直接链接">​</a></h2><p>kubernetes 中所有的内容都抽象为资源，查看资源类型：kubectl api-resources。
| 资源分类      | 资源名称                 | 缩写    | 资源作用        |
| ------------- | ------------------------ | ------- | --------------- |
| 集群级别资源  | nodes                    | no      | 集群组成部分    |
| namespaces    | ns                       | 隔离 Pod |                 |
| pod 资源       | pods                     | po      | 装载容器        |
| pod 资源控制器 | replicationcontrollers   | rc      | 控制 pod 资源     |
|               | replicasets              | rs      | 控制 pod 资源     |
|               | deployments              | deploy  | 控制 pod 资源     |
|               | daemonsets               | ds      | 控制 pod 资源     |
|               | jobs                     |         | 控制 pod 资源     |
|               | cronjobs                 | cj      | 控制 pod 资源     |
|               | horizontalpodautoscalers | hpa     | 控制 pod 资源     |
|               | statefulsets             | sts     | 控制 pod 资源     |
| 服务发现资源  | services                 | svc     | 统一 pod 对外接口 |
|               | ingress                  | ing     | 统一 pod 对外接口 |
| 存储资源      | volumeattachments        |         | 存储            |
|               | persistentvolumes        | pv      | 存储            |
|               | persistentvolumeclaims   | pvc     | 存储            |
| 配置资源      | configmaps               | cm      | 配置            |
|               | secrets                  |         | 配置            |</p><h1>4. Kubernetes 资源</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubectl">kubectl<a href="#kubectl" class="hash-link" aria-label="kubectl的直接链接" title="kubectl的直接链接">​</a></h2><p>kubectl 是和 Kubernetes API 交互的命令行程序。使用 kubectl 来管理 Kubernetes 集群。<br>
<!-- -->Kubectl 是一个命令行工具，可以使用该工具控制 Kubernetes 集群管理器，如检查群集资源，创建、删除和更新组件，查看应用程序。</p><p><strong>kubectl 语法</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">语法：kubectl [command] [type] [name] [flags]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">comand：指定要对资源执行的操作，例如 create、get、delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type：指定资源类型，比如 deployment、pod、service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name：指定资源的名称，名称大小写敏感</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flags：指定额外的可选参数</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>kubectl 基本命令</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看帮助</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --help</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl version    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、查看版本(简单)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl version --short=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、查看 api 版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl api-versions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、查看集群状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cluster-info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、使用安全连接：查看组件信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -s https://10.0.12.14:6443 get componentstatuses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7、查看 kubelet 二进制文件的路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">which kubelet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>kubectl 配置</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看配置(kubectl 配置位于~/.kube/config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config view    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看下有哪些集群上下文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config get-contexts              </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、获取当前 context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config current-context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、切换集群</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config use-context &lt;集群名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、修改集群名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config rename-context &lt;old-context-name&gt; &lt;new-context-name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、--field-selector 参数用于根据字段选择器对资源进行筛选和过滤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get services --all-namespace --field-seletor metadata.namespace != default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>kubectl 使用方式</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、get                                     //显示一个或多个资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、describe                                //显示资源详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、create                                  //从文件或标准输入创建资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、update                                  //从文件或标准输入更新资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、delete                                  //通过文件名、标准输入、资源名或者 label selector 删除资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、log                                     //输出 pod 中一个容器的日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7、rolling-update                          //对指定的 replication controller 执行滚动升级</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8、exec                                    //在容器内部执行命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9、port-forward                            //将本地端口转发到 Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10、proxy                                  //为 Kubernetes API server 启动代理服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11、run                                    //在集群中使用指定镜像启动容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12、expose                                //将 replication controller service 或 pod 暴露为新的 kubernetes service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13、label                                  //更新资源的 label</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14、config                                 //修改 kubernetes 配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15、cluster-info                           //显示集群信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16、api-versions                           //以 &quot;组/版本&quot; 的格式输出服务端支持的 API 版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17、version                                //输出服务端和客户端的版本信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">18、help                                   //显示各个命令的帮助信息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>复制文件</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、复制本地文件到 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl cp &lt;本地文件路径&gt; &lt;pod 名称&gt;:&lt;目录&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl cp /root/tmp/gor_1.3_RC1_x64.tar.gz nginx-deployment-9456bbbf9-9g8zn:/ -n my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、复制 pod 文件到本地</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl cp &lt;pod 名称&gt;:&lt;文件/目录&gt; &lt;本地文件路径&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl cp &lt;pod 名称&gt;:&lt;文件/目录&gt; &lt;本地文件路径&gt; -n &lt;ns 名称&gt; -c &lt;容器名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl cp nginx-deployment-9456bbbf9-9g8zn:/gor_1.3_RC1_x64.tar.gz /root/tmp/test.tar.gz -n my-space</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>其它</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">查看 ns 下所有资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -n my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">删除 ns 下某个服务的所有 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod -n my-space |grep sentry |awk &#x27;{print $1}&#x27;|xargs kubectl delete pod -n my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过--dry-run 来得到 yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create deployment goweb --image=192.168.11.253/library/goweb:latest --port=80 -r 3 -n goweb-namespace --dry-run=client -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--dry-run 的两个常用选项：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--dry-run=client -o yaml 将在本地模拟执行命令，并将模拟执行结果以 YAML 格式输出。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--dry-run=server -o yaml 将命令请求发送到服务器，并由服务器模拟执行命令，返回经过服务器验证的 YAML 格式的资源定义。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="namespace">Namespace<a href="#namespace" class="hash-link" aria-label="Namespace的直接链接" title="Namespace的直接链接">​</a></h2><p>使用 ns 创建多个虚拟集群。
注意：操作命令需指定 -n &lt;ns 名称&gt;，否则会使用默认的 ns 名称 default。
namespace 可简写为 ns。</p><p><strong>4.2.1、查看 ns</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME              STATUS   AGE     //kubernetes 在集群启动之后，会默认创建几个 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default           Active   45h     //所有未指定 ns 的对象都会被分配在 defaultns 名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-node-lease   Active   45h     //集群节点之间的心跳维护，v1.13开始引入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-public       Active   45h     //此 ns 名称下的资源可以被所有人访问（包括未认证用户）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system       Active   45h     //所有由 Kubernetes 系统创建的资源都处于这个 ns 名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、输出 ns 指定格式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get ns -o yaml 或者 kubectl get ns &lt;ns 名称&gt; -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get ns -o yaml 或者 kubectl get ns default -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、查看 ns 下的所有组件运行情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get all -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get all -n default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、查看 ns 详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl describe ns &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe ns default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.2.2、操作 ns</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、创建 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl create ns &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl create ns demo-ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、通过文件创建 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl create -f &lt;yaml 文件名称&gt;.yaml    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl create -f demo-ns.yaml    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">demo-ns.yaml 内容如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name: demo-ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、删除 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl delete namespaces &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl delete ns demo-ns </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、通过文件删除 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl delete -f &lt;yaml 文件名称&gt;.yaml    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl delete -f demo-ns.yaml    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、切换到 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl config set-context $(kubectl config current-context) --ns=&lt;ns 名称&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl config set-context $(kubectl config current-context) --ns=demo-ns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pod-资源">pod 资源<a href="#pod-资源" class="hash-link" aria-label="pod 资源的直接链接" title="pod 资源的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pods">Pods<a href="#pods" class="hash-link" aria-label="Pods的直接链接" title="Pods的直接链接">​</a></h3><p>Pod 是Kubernetes 创建或部署的最小/最简单的基本单位，一个 Pod 代表集群上正在运行的一个进程。
Pod 是一组一个或多个应用程序容器（例如 Docker），包括共享存储（卷)，IP 地址和有关如何运行它们的信息。</p><p>一个 Pod 可以容纳一个或多个紧密相关的容器，这些容器共享相同的网络命名空间和存储卷，容器之间可以通过本地主机网络进行通信，也可以通过共享的存储卷进行数据交换。它们共享相同的 IP 地址和端口空间，并且可以通过 localhost 相互访问。</p><p>注：操作命令需指定 -n &lt;ns 名称&gt;，否则会使用默认的 ns 名称 default。
注：pods 可简写为 pod。</p><p><strong>4.3.1、查看 pod</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">READY 2/2 表示 pod 下两个容器都运行成功，在 yaml 里面定义多个 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看 pod 详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、查看所有 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod --all-namespaces 或者 kubectl get pod -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、查看 pod 标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、指定 ns 查看 pod，默认 default，default 下面可能无 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl get pod -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、查看某个 pod, 以 yaml 格式展示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod &lt;pod 名称&gt; -n &lt;ns 名称&gt; -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl get pod kube-apiserver-wwweeeiii -n kube-system -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7、查看 pod 详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl describe pod &lt;pod 名称&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl describe pod kube-apiserver-wwweeeiii -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8、查看 pod 的容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod &lt;pod 名称&gt; -n &lt;ns 名称&gt; -o jsonpath={.spec.containers[*].name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl get pod my-pod -n my-space -o jsonpath={.spec.containers[*].name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8、查看资源的 cpu，内存磁盘等资源的使用率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl top pod --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9、查看 pod 中的容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod &lt;pod 名称&gt; -o jsonpath=&quot;{.spec[&#x27;containers&#x27;,&#x27;initContainers&#x27;][*].name}&quot; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl get pod redis -o jsonpath=&quot;{.spec[&#x27;containers&#x27;,&#x27;initContainers&#x27;][*].name}&quot; -n my-space</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.3.2、查看日志</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、实时打印容器中日志信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl logs &lt;pod 名称&gt; -f -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl logs kube-apiserver-wwweeeiii -f -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、实时打印容器中最新 N条日志信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl logs &lt;pod 名称&gt; -f --tail=N</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl logs kube-apiserver-wwweeeiii -f --tail=20 -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、指定 pod 中的容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl logs &lt;pod 名称&gt; -c &lt;容器名称&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl logs kube-apiserver-wwweeeiii -c kube-apiserver -n kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.3.3、操作 pod</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、进入 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl exec -it &lt;pod 名称&gt; -- sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl exec -it nginx-7cbb8cd5d8-qfzsx -- sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">踩坑：无法执行 kube-apiserver-wwweeeiii，于是我换了一个自定义的容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、进入 pod 中的容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl exec -it &lt;pod 名称&gt;  --container &lt;容器名称&gt;  sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、在 pod 中执行命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl exec &lt;pod 名称&gt; date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl exec -it nginx-7cbb8cd5d8-qfzsx -- date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、重启 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod &lt;pod 名称&gt; -n &lt;ns 名称&gt; -o yaml | kubectl replace --force -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl get pod nginx-7cbb8cd5d8-qfzsx -n default -o yaml | kubectl replace --force -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、删除 pod --force：强制删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl delete pod &lt;pod 名称&gt; -n &lt;ns 名称&gt; --grace-period=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl delete pod nginx -n demo --grace-period=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl delete pod nginx -n demo --force --grace-period=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、无法强制删除 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod -n &lt;ns 名称&gt;，查看 pod 对应的控制器，比如 pod 对应的控制器是 Replication Controller，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行：kubectl get rc -A，先删除 rc：kubectl delete rc -n &lt;ns 名称&gt;，pod 自然就被删除</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.3.4、pod 驱逐</strong></p><p>pod 驱逐：k8s 的业务节点在某些资源(磁盘空间，内存)快要耗尽时提前按照服务优先级驱逐某些 pod 以达到释放相关资源保证集群稳定性的目的。
驱逐条件：不可压缩资源(内存,磁盘等) 使用到达 kubelet 规定的阈值时。
驱逐流程：kubelet 的eviction 模块从本机的 cgroup 或者 cadvisor 中去捞相关使用资源数据，然后跟设置的驱逐阈值对比(例如 memory.available 等)，然后根据集群使用的驱逐策略(软硬驱逐策略) 去干掉低优先级的 pod 释放出紧缺的资源，保证节点的可用性。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">手动驱逐 pod，当我们需要对一个节点进行维护，或者删除这个节点的时候，需要手动将布置在上面的 Pod 主动驱逐出来，以便不影响业务的连续性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">驱动 node 节点上的 Pod（先设置 node 为cordon 不可调度状态，然后驱逐 Pod）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl drain &lt;node name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">维护完后需要将节点设置为可调度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：ubectl uncordon &lt;node name&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.3.5、pod 状态说明</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、Pending                                    //等待中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、Running                                    //运行中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、Succeeded                                  //正常终止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、Failed                                     //异常停止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、Unkonwn                                    //未知状态</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.3.6、pod 详细状态说明</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、Completed                                   //job 资源正常启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、CrashLoopBackOff                            //容器退出，kubelet 正在将它重启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、InvalidImageName                            //无法解析镜像名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、ImageInspectError                           //无法校验镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、ErrImageNeverPull                           //策略禁止拉取镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、ImagePullBackOff                            //正在重试拉取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7、RegistryUnavailable                         //连接不到镜像中心</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8、ErrImagePull                                //通用的拉取镜像出错</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9、CreateContainerConfigError                  //不能创建 kubelet 使用的容器配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10、CreateContainerError                        //创建容器失败</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11、m.internalLifecycle.PreStart                //Container 执行 hook 报错</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12、RunContainerError                           //启动容器失败</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13、PostStartHookError                          //执行 hook 报错</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14、ContainersNotInitialized                    //容器没有初始化完毕</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15、ContainersNotRead                           //容器没有准备完毕</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16、ContainerCreating                           //容器创建中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17、PodInitializing pod                         //初始化中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">18、DockerDaemonNotReady                        //docker 还没有完全启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19、NetworkPluginNotReady                       //网络插件还没有完全启动</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.3.7、pod nodeSelector</strong></p><p>在 Kubernetes 中，<code>nodeSelector</code> 是一种机制，用于将 Pod 调度到具有特定标签的节点上。NodeSelector 允许您将 Pod 调度到特定的节点上，这些节点必须包含与 Pod 上定义的选择器匹配的标签。</p><p>举例：在这个例子中，<code>nodeSelector</code> 指定了 <code>env: production</code>，这意味着该 Pod 将仅在具有 <code>env: production</code> 标签的节点上运行。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodeSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env: production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: my-container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - containerPort: 80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看节点标签 <code>kubectl get nodes --show-labels</code> 或者 <code>kubectl describe node &lt;node-name&gt;</code></p><p>给节点添加标签 <code>kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt;</code></p><p>举例 <code>kubectl label nodes vm-12-14-centos env=production</code></p><p><strong>4.3.8 pod nodeName</strong></p><p>在 Kubernetes 的 Pod 配置中，<code>nodeName</code> 是一个可选字段，用于指定 Pod 调度到的节点的名称。当想要将 Pod 调度到特定节点上时，可以使用 <code>nodeName</code> 字段来指定。</p><p>举例：在这个例子中，<code>nodeName</code> 设置为 <code>node-1</code>，这意味着该 Pod 将调度到名为 <code>node-1</code> 的节点上。如果没有名为 <code>node-1</code> 的节点可用，Pod 将无法被调度。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodeName: node-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: my-container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - containerPort: 80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.3.9 pod HostAliases</strong></p><p>在 Kubernetes 中，<code>HostAliases</code> 是一种 Pod 配置字段，允许在 Pod 内部定义主机名和 IP 地址的别名。这些别名将被添加到 Pod 的 hosts 文件中，从而使 Pod 内的应用程序可以使用这些别名来访问其他容器或主机。</p><p>定义 Pod 的hosts 文件里的内容，也就是/etc/hosts 里的内容。用法如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostAliases:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ip: &quot;11.22.33.44&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hostnames:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - &quot;foo.joker.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: container-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: container-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo Hello from container-2! &amp;&amp; sleep 3600&#x27;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>进入 pod <code>kubectl exec -it my-pod -n my-space -- bash</code>  执行 <code>cat /etc/hosts</code> 可查看内容 <code>11.22.33.44 foo.joker.com </code></p><p><strong>4.3.10 pod LivenessProbe</strong></p><p>在 Kubernetes 中，<code>LivenessProbe</code> 是一种 Pod 配置字段，用于确定容器是否正在运行正常。<code>LivenessProbe</code> 可以检测容器中的故障，并在发现故障时采取适当的行动，例如重启容器。</p><p><code>LivenessProbe</code> 可以使用以下三种方式进行检测：</p><ol><li><strong>HTTP 探针</strong>：发送 HTTP 请求并检查响应代码。</li><li><strong>TCP 探针</strong>：尝试建立 TCP 连接。</li><li><strong>执行探针</strong>：在容器内执行命令，并检查返回代码或输出。</li></ol><p>以下是一个包含 <code>LivenessProbe</code> 字段的 Pod 配置示例：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: my-container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    livenessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path: /healthz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initialDelaySeconds: 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      periodSeconds: 10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>initialDelaySeconds</code> 参数为 30，这意味着在容器启动后等待 30 秒后才开始进行探测</p><p><code>periodSeconds</code> 参数为 10，这意味着每 10 秒将进行一次探测</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pod-资源控制器">pod 资源控制器<a href="#pod-资源控制器" class="hash-link" aria-label="pod 资源控制器的直接链接" title="pod 资源控制器的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a href="#deployment" class="hash-link" aria-label="Deployment的直接链接" title="Deployment的直接链接">​</a></h3><p>Deployment 是pod 的控制器之一。为了实现在 Kubernetes 集群上部署容器化应用程序。需要创建一个 Kubernetes  <strong><a href="http://docs.kubernetes.org.cn/317.html" target="_blank" rel="noopener noreferrer">Deployment</a>，</strong>Deployment 负责创建和更新应用。创建 Deployment 后，Kubernetes master 会将 Deployment 创建好的应用实例调度到集群中的各个节点。
应用实例创建完成后，Kubernetes Deployment Controller 会持续监视这些实例。如果管理实例的节点被关闭或删除，那么 Deployment Controller 将会替换它们，实现自我修复能力。
注：deployment 可简写为 deploy。</p><p><strong>4.查看 deployment</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看 deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get deploy -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">READY：用户期望的 Pod 个数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UP-TO-DATE：成功升级的副本数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AVAILABLE：可用副本的数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看 deployment 详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get deploy -A -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、查看 deployment 详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl describe deploy &lt;deploy 名称&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl describe deploy nginx -n default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.4.2、操作 deployment</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、创建 deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl create deploy &lt;deploy 名称&gt; [参数]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image  指定 pod 的镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--port   指定端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--replicas  指定创建 pod 数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ns  指定 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl run nginx --image=nginx:latest --port=80 --replicas=3 -n demo（没成功）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f nginx-deployment.yaml --record</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在创建的命令上加一个--record，它的作用是记录每次我们操作所执行的命令，方便后面操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、手动扩容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl scale deployment &lt;deploy 名称&gt; --replicas 副本数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl scale deployment nginx --replicas 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、手动缩容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl scale deployment &lt;deploy 名称&gt; --replicasa=&lt;副本数&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl scale deployment nginx --replicas=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、自动扩容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl autoscale deployment &lt;deploy 名称&gt; --min=&lt;最小副本数&gt; --max=&lt;最大副本数&gt; --cpu-percent=&lt;cpu 占用百分比&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl autoscale deployment nginx --min=1 --max=10 --cpu-percent=10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、自动缩容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、删除 deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl delete &lt;deploy 名称&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl delete nginx -n demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7、修改副本数 replicas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl edit deployment/&lt;deploy 名称&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl edit deployment/nfs-subdir-external-provisioner -n my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">直接回滚到上一个版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout undo deployment/nginx-deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看历史版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout history deployment/nginx-deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">回滚到指定的历史版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout history deployment/nginx-deployment --revision=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">重新启动一个正在运行的 Kubernetes 部署（Deployment），它会触发一个滚动更新，以重新创建部署的所有Pod实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment/[DEPLOYMENT_NAME]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment/[DEPLOYMENT_NAME] --namespace=[NAMESPACE]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.4.3、查看 deployment 组成</strong></p><p>kubectl explain deployment</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KIND:     Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION:  apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DESCRIPTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Deployment enables declarative updates for Pods and ReplicaSets.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FIELDS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   apiVersion &lt;string&gt;      //该资源使用的 api 版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   kind &lt;string&gt;            //创建的资源是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   metadata &lt;Object&gt;        //元数据，包括资源的名字和名称空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   spec &lt;Object&gt;            //定义容器的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   status &lt;Object&gt;          //状态，不可以修改</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.4.4、查看 deployment 下的 spec 字段</strong></p><p>kubectl explain deployment.spec</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KIND:     Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION:  apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCE: spec &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DESCRIPTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Specification of the desired behavior of the Deployment.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     DeploymentSpec is the specification of the desired behavior of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Deployment.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FIELDS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minReadySeconds &lt;integer&gt;         //默认单位秒，Kubernetes 在等待设置的时间后才进行升级，如果没有设置该值，Kubernetes 会假设该容器启动起来后就提供服务了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    paused &lt;boolean&gt;                        //暂停，当我们更新的时候创建 pod 先暂停，不是立即更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    progressDeadlineSeconds &lt;integer&gt; //默认单位秒，Kubernetes 在升级过程中有可能由于各种原因升级卡住（这个时候还没有明确的升级失败），比如在拉取被墙的镜像，权限不够等错误。那么这个时候就需要有个 deadline ，在 deadline 之内如果还卡着，那么就上报这个情况，这个时候这个 Deployment 状态就被标记为 False，并且注明原因。但是它并不会阻止 Deployment 继续进行卡住后面的操作。完全由用户进行控制。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    replicas &lt;integer&gt;                  //副本数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    revisionHistoryLimit &lt;integer&gt;    //保留的历史版本，默认是10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selector &lt;Object&gt; -required-      //标签选择器，选择它关联的 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strategy &lt;Object&gt;                 //更新策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    template &lt;Object&gt; -required       //定义的 pod 模板，几乎和 Replicaset 控制器的 template 字段相同</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.4.5、查看 deployment 下的 spec.strategy 字段</strong></p><p>kubectl explain deploy.spec.strategy</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KIND:     Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION:  apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCE: strategy &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DESCRIPTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     The deployment strategy to use to replace existing pods with new ones.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     DeploymentStrategy describes how to replace existing pods with new ones.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FIELDS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   rollingUpdate &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   type &lt;string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Type of deployment. Can be &quot;Recreate&quot; or &quot;RollingUpdate&quot;. Default is</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     RollingUpdate.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  支持两种更新，Recreate 和RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Recreate 是重建式更新，删除一个更新一个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RollingUpdate 滚动更新，定义滚动更新方式，也就是 pod 能多几个，少几个</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.4.6、查看 deployment 下的 spec.strategy.rollingUpdate 字段</strong></p><p>kubectl explain deploy.spec.strategy.rollingUpdate</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KIND:     Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION:  apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCE: rollingUpdate &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DESCRIPTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Rolling update config params. Present only if DeploymentStrategyType =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     RollingUpdate.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Spec to control the desired behavior of rolling update.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FIELDS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   maxSurge &lt;string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我们更新的过程当中最多允许超出的指定的目标副本数有几个； </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   maxUnavailable &lt;string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">最多允许几个不可用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">假设有5个副本，最多一个不可用，就表示最少有4个可用</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="replication-controller">Replication Controller<a href="#replication-controller" class="hash-link" aria-label="Replication Controller的直接链接" title="Replication Controller的直接链接">​</a></h3><p>应用托管在 Kubernetes 之后，Kubernetes 需要保证应用能够持续运行，这是 RC 的工作内容，它会确保任何时间 Kubernetes 中都有指定数量的 Pod 在运行。在此基础上，RC 还提供了一些更高级的特性，比如滚动升级、升级回滚等。
注：replication controller 可简写为 rc。</p><p><strong>4.7.1、查看 rc</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看所有 rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get rc -A</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.7.2、操作 rc</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、创建 rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl create -f &lt;rc 文件名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl create -f nginx-demo.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[nginx-demo.yaml]<!-- -->(./yml 集合/Nginx/nginx-demo.yml)</p><p>RC 的作用就是时刻保证我们配置副本数在 Kubernetes 上健壮的运行，当检测到一个副本容器关闭后，会立刻在启动一个副本的容器。下面测试下他是否能保证我们创建的2个副本容器始终在运行。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">删除 rc 下运行的一个 pod，自动创建了一个新的 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pod nginx-demo-55s9d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>RC 与pod 关联关系</strong></p><p>RC 是如何判断哪些 pod 是由它来管理，就是通过 rc 配置文件中的 label 标签，只要和 rc 标签一样的 pod，都会被这个 rc 管理。</p><p><strong>RC 的升级</strong>
滚动升级是一种平滑过渡的升级方式，通过逐步替换的策略，保证整体系统的稳定，在初始升级的时候就可以及时发现、调整问题，以保证问题影响度不会扩大。
升级开始后，首先依据提供的定义文件创建 V2版本的 RC，然后每隔10s（–update-period=10s）逐步的增加 V2版本的 Pod 副本数，逐步减少 V1版本 Pod 的副本数。升级完成之后，删除 V1版本的 RC，保留 V2版本的 RC，及实现滚动升级。
升级过程中，发生了错误中途退出时，可以选择继续升级。Kubernetes 能够智能的判断升级中断之前的状态，然后紧接着继续执行升级。当然，也可以进行回退。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rolling-update nginx-demo -f nginx-demo2.yaml --update-period=10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-demo2.yaml 文件把原先 nginx-demo 改为 nginx-demo2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">回滚命令说明</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-demo：被升级的 RC 名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">update-period=30s：新创建的容器存活30秒后删除之前版本的容器，再启动下个副本</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>RC 回滚</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rolling-update nginx-demo2 -f nginx-demo.yaml --update-period=1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">回滚命令说明</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-demo2：被回滚的 RC 名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-demo.yaml：回滚到具体版本的 RC 文件</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="replicaset">ReplicaSet<a href="#replicaset" class="hash-link" aria-label="ReplicaSet的直接链接" title="ReplicaSet的直接链接">​</a></h3><p>RS 和RC 的功能基本一致，目前唯一的一个区别就是 RC 只支持基于等式的 selector（env=dev 或environment!=qa）</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="statefulset">StatefulSet<a href="#statefulset" class="hash-link" aria-label="StatefulSet的直接链接" title="StatefulSet的直接链接">​</a></h3><p><a href="http://docs.kubernetes.org.cn/443.html" target="_blank" rel="noopener noreferrer">StatefulSet 文档1</a>
<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener noreferrer">StatefulSet 文档2</a></p><p>StatefulSet 是用来管理有状态应用的工作负载 API 对象。
StatefulSet 用来管理某 <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">Pod</a> 集合的部署和扩缩， 并为这些 Pod 提供持久存储和持久标识符。
和 <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener noreferrer">Deployment</a> 类似， StatefulSet 管理基于相同容器规约的一组 Pod。但和 Deployment 不同的是， StatefulSet 为它们的每个 Pod 维护了一个有粘性的 ID。这些 Pod 是基于相同的规约来创建的，但是不能相互替换：无论怎么调度，每个 Pod 都有一个永久不变的 ID。
如果希望使用存储卷为工作负载提供持久存储，可以使用 StatefulSet 作为解决方案的一部分。 尽管 StatefulSet 中的单个 Pod 仍可能出现故障， 但持久的 Pod 标识符使得将现有卷与替换已失败 Pod 的新 Pod 相匹配变得更加容易。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="daemonset">DaemonSet<a href="#daemonset" class="hash-link" aria-label="DaemonSet的直接链接" title="DaemonSet的直接链接">​</a></h3><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener noreferrer">DaemonSet</a></p><p><strong>DaemonSet</strong> 确保全部（或者某些）节点上运行一个 Pod 的副本。 当有节点加入集群时， 也会为他们新增一个 Pod 。 当有节点从集群移除时，这些 Pod 也会被回收。删除 DaemonSet 将会删除它创建的所有 Pod。</p><p>DaemonSet 的一些典型用法：</p><ul><li>在每个节点上运行集群守护进程</li><li>在每个节点上运行日志收集守护进程</li><li>在每个节点上运行监控守护进程</li></ul><p>一种简单的用法是为每种类型的守护进程在所有的节点上都启动一个 DaemonSet。 一个稍微复杂的用法是为同一种守护进程部署多个 DaemonSet；每个具有不同的标志， 并且对不同硬件类型具有不同的内存、CPU 要求。</p><p>下面是常用的使用案例：</p><ul><li>集群守护进程，如<code>Kured</code>、<code>node-problem-detector</code></li><li>日志收集守护进程，如<code>fluentd</code>、<code>logstash</code></li><li>监控守护进程，如<code>promethues</code>、 <code>node-exporter</code></li><li>网络插件的 Agent 组件，都必须运行在每一个节点上，用来处理这个节点上的容器网络。</li><li>存储插件的 Agent 组件，也必须运行在每一个节点上，用来在这个节点上挂载远程存储目录，操作容器的 Volume 目录，比如：glusterd、ceph。</li></ul><p><strong>通过创建 DaemonSet 可以确保 守护进程 pod 被调度到每个可用节点上运行。</strong></p><p>[daemonset-demo.yaml]<!-- -->(./yml 集合/daemonset-demo.yaml)  </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f daemonset-demo.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get daemonset / kubectl get ds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="服务发现资源">服务发现资源<a href="#服务发现资源" class="hash-link" aria-label="服务发现资源的直接链接" title="服务发现资源的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="service">Service<a href="#service" class="hash-link" aria-label="Service的直接链接" title="Service的直接链接">​</a></h3><p>Service 可以看作是一组同类 Pod 对外的访问接口。借助 Service，应用可以方便地实现服务发现和负载均衡。
注：service 可简写为 svc。</p><p><strong>4.5.1、查看 service</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看 service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get svc -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看 service 详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get svc -A -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、查看 service 详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl describe svc &lt;svc 名称&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl describe svc kube-dns -n kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.5.2、操作 service</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、创建集群内部可访问的 service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl expose deploy &lt;deploy 名称&gt; --name=&lt;svc 名称&gt; --type=ClusterIP --port=80 --target-port=80 -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">说明：这里产生了一个 CLUSTER-IP，这就是 service 的IP，在 Service 的生命周期中，这个地址是不会变动的，可以通过这个 IP 访问当前 service 对应的 POD。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、创建集群外部也可访问的 Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl expose deploy &lt;deploy 名称&gt; --name=&lt;svc 名称&gt; --type=NodePort --port=80 --target-port=80 -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">说明：上面创建的 Service 的type 类型为 ClusterIP，这个 ip 地址只用集群内部可访问，如果需要创建外部也可以访问的 Service，需要修改 type 为NodePort。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在的电脑主机上通过浏览器访问下面的地址：http://127.0.0.1:&lt;端口号&gt;/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/svc-nginx2 exposed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">注：在Kubernetes中，默认的端口范围是从30000到32767。这个范围被称为&quot;NodePort&quot;服务的默认端口范围。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、删除 service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl delete svc &lt;svc 名称&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl delete svc svc-nginx-1 -n demo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ingress">Ingress<a href="#ingress" class="hash-link" aria-label="Ingress的直接链接" title="Ingress的直接链接">​</a></h3><p>在 Kubernetes 中，<code>ingress</code> 是一种用于将外部流量路由到 Kubernetes 集群中的服务的机制。它允许你在集群外部暴露 HTTP 和 HTTPS 服务，并提供了路由、负载均衡、TLS 终止等功能。</p><p><a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreferrer">Ingress 文档</a></p><p>Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。</p><p>Ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</p><p>注：ingress 可简写为 ing。</p><p><img loading="lazy" src="/assets/images/Ingress-6008f4e2089e0003f28a7205cff6be81.png" width="1322" height="486" class="img_ev3q"></p><p><strong>查看 ingress</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看所有 ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get ing -A</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>操作 ingress</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、创建 ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl create -f &lt;ingress 文件名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl create -f ingress-demo.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、安装 ingress-nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install ingress-nginx ingress-nginx \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--repo https://kubernetes.github.io/ingress-nginx \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ns ingress-nginx --create-ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.4.0/deploy/static/provider/cloud/deploy.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、查看 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pods --ns=ingress-nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="存储资源">存储资源<a href="#存储资源" class="hash-link" aria-label="存储资源的直接链接" title="存储资源的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="persistentvolume">PersistentVolume<a href="#persistentvolume" class="hash-link" aria-label="PersistentVolume的直接链接" title="PersistentVolume的直接链接">​</a></h3><p><strong>存储</strong></p><p><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/" target="_blank" rel="noopener noreferrer">存储文档1</a>
<a href="https://kuboard.cn/learning/k8s-intermediate/persistent/volume.html" target="_blank" rel="noopener noreferrer">存储文档2</a></p><p><strong>持久卷（PersistentVolume，PV）</strong> 是集群中的一块存储，可以由管理员事先制备， 或者使用<a href="https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener noreferrer">存储类（Storage Class）</a>来动态制备。 持久卷是集群资源，就像节点也是集群资源一样。PV 持久卷和普通的 Volume 一样， 也是使用卷插件来实现的，只是它们拥有独立于任何使用 PV 的 Pod 的生命周期。 此 API 对象中记述了存储的实现细节，无论其背后是 nfs、iSCSI 还是特定于云平台的存储系统。</p><p><strong>持久卷申领（PersistentVolumeClaim，PVC）</strong> 表达的是用户对存储的请求。概念上与 Pod 类似。 Pod 会耗用节点资源，而 PVC 申领会耗用 PV 资源。Pod 可以请求特定数量的资源（CPU 和内存）；同样 PVC 申领也可以请求特定的大小和访问模式 （例如，可以要求 PV 卷能够以 ReadWriteOnce、ReadOnlyMany 或 ReadWriteMany 模式之一来挂载，参见<a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#access-modes" target="_blank" rel="noopener noreferrer">访问模式</a>）。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看 PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、删除 PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pvc &lt;pvc 名称&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 Kubernetes 中，PVC（Persistent Volume Claim）和 PV（Persistent Volume）是用于实现持久化存储的两个核心概念。它们的主要区别如下：</p><ol><li><p>PV 是底层存储资源，而 PVC 是对 PV 的请求。PV 是一个抽象的存储卷，它表示实际的存储资源，可以是物理存储设备、网络存储、云存储等。而 PVC 是对 PV 的请求，它定义了需要的存储资源的类型、大小和访问模式等。</p></li><li><p>PV 是管理员创建的资源，而 PVC 是应用程序开发人员创建的资源。管理员通过创建 PV 来提供存储资源，而开发人员可以通过创建 PVC 来请求存储资源。</p></li><li><p>PV 和 PVC 之间存在一对一或多对一的关系。一个 PV 可以被多个 PVC 使用，但一个 PVC 只能绑定一个 PV。</p></li><li><p>PV 和 PVC 之间可以通过不同的方式进行绑定。静态绑定是管理员手动将 PV 和 PVC 绑定在一起，而动态绑定是 Kubernetes 自动将 PVC 与可用的 PV 进行绑定。</p></li><li><p>PV 可以独立于应用程序而存在，而 PVC 是应用程序的一部分。当应用程序被删除时，PVC 也会被删除。</p><p>PVC 和 PV 是 Kubernetes 中持久化存储的两个核心概念，它们的关系类似于文件系统中的文件和磁盘。</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storageclass">storageclass<a href="#storageclass" class="hash-link" aria-label="storageclass的直接链接" title="storageclass的直接链接">​</a></h3><p>注：storageclass 可简写为 sc。</p><p><strong>搭建 nfs 服务端</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">前提</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1、下载安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install nfs-utils rpcbind -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、创建共享目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /root/nfs/tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、修改权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod -R 777 /root/nfs/tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、修改配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim /etc/exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">前面是共享目录，后面星代表所有 ip，fsid、anonuid、anongid 是给从节点写入权限，0代表 root 用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;/root/nfs/tmp *(rw,sync,fsid=0,anonuid=0,anongid=0)&quot; &gt;&gt; /etc/exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;/data/k8s/prometheus *(rw,sync,fsid=0,anonuid=0,anongid=0)&quot; &gt;&gt; /etc/exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;/data/k8s/grafana *(rw,sync,fsid=0,anonuid=0,anongid=0)&quot; &gt;&gt; /etc/exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">常用选项：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ro：客户端挂载后，其权限为只读，默认选项；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rw:读写权限；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync：同时将数据写入到内存与硬盘中；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async：异步，优先将数据保存到内存，然后再写入硬盘；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secure：要求请求源的端口小于1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用户映射：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root_squash:当 NFS 客户端使用 root 用户访问时，映射到 NFS 服务器的匿名用户；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">no_root_squash:当 NFS 客户端使用 root 用户访问时，映射到 NFS 服务器的 root 用户；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">all_squash:全部用户都映射为服务器端的匿名用户；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">anonuid=UID：将客户端登录用户映射为此处指定的用户 uid；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">anongid=GID：将客户端登录用户映射为此处指定的用户 gid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">配置生效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exportfs -r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看生效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exportfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">启动 rpcbind、nfs 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart rpcbind &amp;&amp; systemctl enable rpcbind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart nfs-server &amp;&amp; systemctl enable nfs-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看 nfs 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status nfs-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>搭建 nfs 客户端</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、下载安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install nfs-utils rpcbind -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、启动 rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart rpcbind &amp;&amp; systemctl enable rpcbind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、查看共享目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">showmount -e 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export list for 127.0.0.1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/root/nfs/tmp     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、创建目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /root/nfs/tmp2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、挂载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mount -t nfs 127.0.0.1:/root/nfs/tmp /root/nfs/tmp2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果想要开机自动将共享目录挂载到本地,往/etc/fstab 中追加：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;127.0.0.1:/root/nfs/tmp /root/nfs/tmp2 nfs defaults 0 0&quot; &gt;&gt; /etc/fstab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看目录挂载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df -h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">测试（好像没用）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir /tmp/testnfs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;&amp; mount -t nfs : /tmp/testnfs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;&amp; echo &quot;hello nfs&quot; &gt;&gt; /tmp/testnfs/test.txt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;&amp; cat /tmp/testnfs/test.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>NFS-Subdir-External-Provisioner</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">存储组件 NFS subdir external provisioner 是一个存储资源自动调配器，它可用将现有的 NFS 服务器通过持久卷声明来支持 Kubernetes 持久卷的动态分配。自动新建的文件夹将被命名为 𝑛𝑎𝑚𝑒𝑠𝑝𝑎𝑐𝑒−{pvcName}-${pvName}，由三个资源名称拼合而成。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">此组件是对 nfs-client-provisioner 的扩展，nfs-client-provisioner 已经不提供更新，且 nfs-client-provisioner 的 Github 仓库已经迁移到 NFS-Subdir-External-Provisioner 的仓库。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>k8s 创建 storageclass</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、创建资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f storageclass-nfs.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storageclass-nfs.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: StorageClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-nfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provisioner: storage.pri/nfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reclaimPolicy: Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allowVolumeExpansion: True  #允许 pvc 创建后扩容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get storageclass -n my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、设置设置为默认存储类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch storageclass my-nfs -p &#x27;{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;}}}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>k8s 创建 pvc</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、创建资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f pvc-test.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pvc-test.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-pvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volume.beta.kubernetes.io/storage-class: &quot;my-nfs&quot;   #与 storageclass-nfs.yml metadata.name 保持一致</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteMany</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: 1Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pvc -n my-space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、删除资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete -f pvc-test.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置资源">配置资源<a href="#配置资源" class="hash-link" aria-label="配置资源的直接链接" title="配置资源的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configmap">ConfigMap<a href="#configmap" class="hash-link" aria-label="ConfigMap的直接链接" title="ConfigMap的直接链接">​</a></h3><p><a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer">ConfigMap 文档</a></p><p>ConfigMap 是一种 API 对象，用来将非机密性的数据保存到键值对中。使用时， <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">Pods</a> 可以将其用作环境变量、命令行参数或者存储卷中的配置文件。
ConfigMap 将你的环境配置信息和 <a href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-image" target="_blank" rel="noopener noreferrer">容器镜像</a> 解耦，便于应用配置的修改。
注意：ConfigMap 并不提供保密或者加密功能。 如果你想存储的数据是机密的，请使用 <a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreferrer">Secret</a>， 或者使用其他第三方工具来保证你的数据的私密性，而不是用 ConfigMap。
注：ConfigMap 可简写为 cm。</p><p><strong>查看 configmap</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看 configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get cm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看 configmap 详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe cm &lt;configmap 命令&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe cm kube-root-ca.crt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>操作 configmap</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、通过键值对创建 configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create cm my-config --from-literal=key1=hello --from-literal=key2=world</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe cm my-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、kubctl create -f confi.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim config.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> name: my-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> key1: hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> key2: world</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="secret">Secret<a href="#secret" class="hash-link" aria-label="Secret的直接链接" title="Secret的直接链接">​</a></h3><p>通过文件生成 secret 对象</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret generic &lt;secretname&gt; --from-file=./&lt;filename&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret generic demo --from-file=./demo.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过 YAML 方式生成</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-secret-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type: Opaque</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user: cm9vdA==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password: UEBzc1cwcmQ=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>base64转码： echo -n &quot;root&quot; | base64</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="其它">其它<a href="#其它" class="hash-link" aria-label="其它的直接链接" title="其它的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="poddisruptionbudget">PodDisruptionBudget<a href="#poddisruptionbudget" class="hash-link" aria-label="PodDisruptionBudget的直接链接" title="PodDisruptionBudget的直接链接">​</a></h3><p>主动销毁 Pod 的时候，为了避免一次性销毁太多 Pod，Kubernetes 引用 PodDisruptionBudget（PDB）控制器，用来控制集群中 Pod 的运行个数。</p><p>在 PDB 中，主要通过两个参数来控制 Pod 的数量：</p><ul><li>minAvailable：表示最小可用 Pod 数，表示在 Pod 集群中处于运行状态的最小 Pod 数或者是运行状态的 Pod 数和总数的百分比；</li><li>maxUnavailable：表示最大不可用 Pod 数，表示 Pod 集群中处于不可用状态的最大 Pod 数或者不可用状态 Pod 数和总数的百分比；</li></ul><p>注意：minAvailable 和maxUnavailable 是互斥了，也就是说两者同一时刻只能出现一种。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pdb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="podsecuritypolicy">PodSecurityPolicy<a href="#podsecuritypolicy" class="hash-link" aria-label="PodSecurityPolicy的直接链接" title="PodSecurityPolicy的直接链接">​</a></h3><p>PodSecurityPolicy 是集群级别的 Pod 安全策略，自动为集群中的 Pod 和Volume 设置 Security Context。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SA 指定了哪个控制器可以解析哪些策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get serviceaccount -n kube-system | egrep -o &#x27;[A-Za-z0-9-]+-controller&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="label">Label<a href="#label" class="hash-link" aria-label="Label的直接链接" title="Label的直接链接">​</a></h3><p>Label 作用就是在资源上添加标识，用来对它们进行区分和选择。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod &lt;pod 名称&gt;  -n &lt;ns 名称&gt; --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl get pod kube-apiserver-wwweeeiii -n kube-system --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、为 pod 资源打标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl label pod &lt;pod 名称&gt; &lt;key&gt;=&lt;value&gt; -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl label pod nginx version=lable_test -n demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、为 pod 资源更新标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl label pod &lt;pod 名称&gt; &lt;key&gt;=&lt;value&gt; -n &lt;ns 名称&gt; --overwrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl label pod nginx version=lable_test_update -n demo --overwrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、筛选标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get pod -n &lt;ns 名称&gt; -l &lt;key&gt;=&lt;value&gt;  --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl get pod -n demo -l version=lable_test_update --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl get pod -n demo -l version!=lable_test_update --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、删除标签（注意：key 后面有个-）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl label pod &lt;pod 名称&gt; &lt;key&gt;- -n &lt;ns 名称&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl label pod nginx version- -n demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、给节点打标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl label node 127.0.0.1 daemon=need</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="job">Job<a href="#job" class="hash-link" aria-label="Job的直接链接" title="Job的直接链接">​</a></h3><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/job/" target="_blank" rel="noopener noreferrer">Job</a></p><p>Job 会创建一个或者多个 Pod，并将继续重试 Pod 的执行，直到指定数量的 Pod 成功终止。 随着 Pod 成功结束，Job 跟踪记录成功完成的 Pod 个数。 当数量达到指定的成功个数阈值时，任务（即 Job）结束。 删除 Job 的操作会清除所创建的全部 Pod。 挂起 Job 的操作会删除 Job 的所有活跃 Pod，直到 Job 被再次恢复执行。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://kubernetes.io/examples/controllers/job.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs jobs/pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get job</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="event">Event<a href="#event" class="hash-link" aria-label="Event的直接链接" title="Event的直接链接">​</a></h3><p>Kubernetes 事件是一个对象，它显示了集群、节点、pod 或容器中正在发生的事情。这些对象通常是根据 K8s 系统中发生的更改而生成的。Kubernetes API Server 允许所有核心组件创建这些事件。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、以 json 格式查看事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl get events -o json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-server">metrics-server<a href="#metrics-server" class="hash-link" aria-label="metrics-server的直接链接" title="metrics-server的直接链接">​</a></h3><p>metrics 是一个监控系统资源使用的插件，可以监控 node 节点上的 CPU、内存的使用率，或 pod 对资源的占用率。</p><p>文件：/etc/kubernetes/manifests/kube-apiserver.yaml</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get APIService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">修改：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- --kubelet-insecure-tls </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.6.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f components.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod -n kube-system|grep metrics-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl top node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl top pod -n my-space</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="crd">CRD<a href="#crd" class="hash-link" aria-label="CRD的直接链接" title="CRD的直接链接">​</a></h3><p>CRD 全称是 Custom Resource Definition，本身是一种 Kubernetes 内置的资源类型，即自定义资源的定义，它的定义主要有 apiVersion，kind，metadata，spec 和status。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get crd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl explain crd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scheduler">Scheduler<a href="#scheduler" class="hash-link" aria-label="Scheduler的直接链接" title="Scheduler的直接链接">​</a></h3><ol><li>首先用户通过 Kubernetes 客户端 Kubectl 提交创建 Pod 的 Yaml 的文件，向 Kubernetes 系统发起资源请求，该资源请求被提交到</li><li>Kubernetes 系统中，用户通过命令行工具 Kubectl 向 Kubernetes 集群即 APIServer 用 的方式发送“POST”请求，即创建 Pod 的请求。</li><li>APIServer 接收到请求后把创建 Pod 的信息存储到 Etcd 中，从集群运行那一刻起，资源调度系统 Scheduler 就会定时去监控 APIServer。</li><li>通过 APIServer 得到创建 Pod 的信息，Scheduler 采用 watch 机制，一旦 Etcd 存储 Pod 信息成功便会立即通知 APIServer。</li><li>APIServer 会立即把 Pod 创建的消息通知 Scheduler，Scheduler 发现 Pod 的属性中 Dest Node 为空时（Dest Node=””）便会立即触发调度流程进行调度。</li><li>而这一个创建 Pod 对象，在调度的过程当中有3个阶段：节点预选、节点优选、节点选定，从而筛选出最佳的节点。</li></ol><ul><li>节点预选：基于一系列的预选规则对每个节点进行检查，将那些不符合条件的节点过滤，从而完成节点的预选</li><li>节点优选：对预选出的节点进行优先级排序，以便选出最合适运行 Pod 对象的节点</li><li>节点选定：从优先级排序结果中挑选出优先级最高的节点运行 Pod，当这类节点多于1个时，则进行随机选择</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="etcd">Etcd<a href="#etcd" class="hash-link" aria-label="Etcd的直接链接" title="Etcd的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">连接 kubernetes 的etcd 方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查询 etcd pod 名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get po --namespace=kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">进入 pod 执行 sh 命令框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --namespace=kube-system exec -it etcd-k8s-master sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">拼接命令 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">获取 etcd 证书参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ps -ef | grep etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">拼接好证书后简单进行查询 key 为/开头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdctl --endpoints https://192.168.137.156:2379 --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key --cacert /etc/kubernetes/pki/etcd/ca.crt get --prefix / --keys-only  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查询成员对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdctl --endpoints https://192.168.137.156:2379 --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key --cacert /etc/kubernetes/pki/etcd/ca.crt member list </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查询 key 为/registry/services/specs/default/kubernetes 对应的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdctl --endpoints https://192.168.137.156:2379 --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key --cacert /etc/kubernetes/pki/etcd/ca.crt get /registry/services/specs/default/kubernetes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pull-secret">Pull Secret<a href="#pull-secret" class="hash-link" aria-label="Pull Secret的直接链接" title="Pull Secret的直接链接">​</a></h3><p>在Kubernetes中，Pull Secret是一种用于从私有容器镜像仓库中拉取镜像的凭证。私有容器镜像仓库通常需要用户名和密码等凭证来访问，而Pull Secret就是用来存储这些凭证信息的Kubernetes对象。</p><p>当您在Kubernetes集群中部署应用程序时，如果您的应用程序需要从私有的容器镜像仓库中拉取镜像，您就需要创建一个Pull Secret对象并将其关联到相应的Pod或ServiceAccount中。这样，Kubernetes就可以使用Pull Secret中存储的凭证信息来从私有镜像仓库中拉取镜像。</p><p>要创建Pull Secret，您可以使用<code>kubectl create secret</code>命令，并指定<code>docker-registry</code>类型。在创建Pull Secret时，您需要提供私有镜像仓库的地址、用户名和密码等信息。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret docker-registry my-pull-secret --docker-server</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">REGISTRY_SERVER --docker-username</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">USERNAME --docker-password</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">PASSWORD --docker-email</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">EMAIL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在创建Pull Secret之后，您可以在Pod的spec中通过<code>imagePullSecrets</code>字段将Pull Secret关联到Pod中，以便Pod可以使用Pull Secret中的凭证信息来拉取镜像。</p><p>总的来说，Pull Secret是用来存储私有容器镜像仓库凭证信息的Kubernetes对象，它允许Kubernetes集群中的应用程序访问私有镜像仓库中的镜像。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cadvisor">cAdvisor<a href="#cadvisor" class="hash-link" aria-label="cAdvisor的直接链接" title="cAdvisor的直接链接">​</a></h3><p>cAdvisor (Container Advisor，容器监控)是 Google 开发的用于分析运行中容器的资源占用和性能指标的开源工具。cAdvisor 是一个运行时的守护进程，负责收集、聚合、处理和输出运行中容器的信息。<br>
<a href="http://github.com/google/cadvisor" target="_blank" rel="noopener noreferrer">Github-cAdvisor 代码仓库</a>
<a href="https://gitee.com/mirrors/cadvisor" target="_blank" rel="noopener noreferrer">Gitee-cAdvisor 代码仓库</a>  </p><p>cAdvisor 安装<br>
<!-- -->cAdvisor 官方提供了 Docker 镜像，拉取镜像并且启动即可。   </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --volume=/dev/disk/:/dev/disk:ro --publish=8080:8080 --detach=true --name=cadvisor --privileged --device=/dev/kmsg lagoudocker/cadvisor:v0.37.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>访问 http:localhost:8080/containers/，在首页可以查看到主机的资源使用情况，包括 CPU、内存、文件系统、网络等。</p><h1>6. 相关概念</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="亲和性和反亲和性">亲和性和反亲和性<a href="#亲和性和反亲和性" class="hash-link" aria-label="亲和性和反亲和性的直接链接" title="亲和性和反亲和性的直接链接">​</a></h2><p>使用背景和场景
业务中的某个关键服务，配置了多个 replica，结果在部署时，发现多个相同的副本同时部署在同一个主机上，结果主机故障时，所有副本同时漂移了，导致服务间断性中断。</p><p>基于以上背景，实现一个服务的多个副本分散到不同的主机上，使每个主机有且只能运行服务的一个副本，这里用到的是 Pod anti-affinity 属性，即 pod 反亲和性，特性是根据已经运行在 node 上的 pod 的label，不再将相同 label 的pod 也调度到该 node，实现每个 node 上只运行一个副本的 pod。</p><p>亲和性调度是指通过配置的形式，实现优先选择满足条件的 Node 进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。  </p><p><strong>亲和性（Affinity）主要分为三类</strong>
节点亲和性（nodeAffinity）：以 node 为目标，解决 pod 可以调度到哪些 node 的问题。<br>
<!-- -->pod 亲和性（podAffinity）：以 pod 为目标，解决 pod 可以和哪些已经存在 pod 部署到同一个拓扑域中的问题。<br>
<!-- -->pod 反亲和性（podAntiAffinity）：以 pod 为目标，解决 pod 不能和哪些已存在的 pod 部署在统一个拓扑域中的问题。  </p><p><strong>亲和性和反亲和性说明</strong>
亲和性：如果两个应用频繁交互，那就有必要利用亲和性让两个应用尽可能靠近，这样可以减少因网络通信而带来的性能损耗。<br>
<!-- -->反亲和性：当应用采用多副本部署时，有必要采用反亲和性让各个应用实例分布在各个 node 节点上，这样可以提高服务的高可用性。 </p><p>反亲和性分软性要求和硬性要求
requiredDuringSchedulingIgnoredDuringExecution：硬性要求，必须满足条件，保证分散部署的效果最好使用用此方式
preferredDuringSchedulingIgnoredDuringExecution：软性要求，可以不完全满足，即有可能同一 node 上可以跑多个副本</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">配置如下，只需要修改 label 的配置，即 matchExpressions 中的 key 和values 的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">硬性要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果节点上的 pod 标签存在满足 app=nginx，则不能部署到节点上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        podAntiAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            topologyKey: &quot;kubernetes.io/hostname&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">软性要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果节点上的 pod 标签存在满足 app=nginx，也可以部署到节点上，尽可能先部署到其它节点，如果没有满足也可以部署到此节点（大概是这么理解吧）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        podAntiAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          preferredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - weight: 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            podAffinityTerm:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - key: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  - nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              topologyKey: &quot;kubernetes.io/hostname&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">查看 pod 在哪个 node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -o wide -n test-namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod -n test-namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">踩坑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning  FailedScheduling  83s   default-scheduler  0/21 nodes are available: 1 node(s) didn&#x27;t match pod affinity rules, 1 node(s) had taint {GiteeCronOnly: yes}, that the pod didn&#x27;t tolerate, 1 node(s) had taint {Prometheus: Grafana}, that the pod didn&#x27;t tolerate, 2 node(s) had taint {GiteeFrontendOnly: yes}, that the pod didn&#x27;t tolerate, 2 node(s) had taint {GiteeInternalOnly: yes}, that the pod didn&#x27;t tolerate, 3 node(s) didn&#x27;t satisfy existing pods anti-affinity rules, 3 node(s) had taint {GiteePraefectOnly: yes}, that the pod didn&#x27;t tolerate, 3 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn&#x27;t tolerate, 4 node(s) didn&#x27;t match pod affinity/anti-affinity, 5 node(s) had taint {GiteeRubyOnly: yes}, that the pod didn&#x27;t tolerate.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这个警告消息表示，没有可用的节点来调度 Pod。这可能是由于以下原因之一：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pod 反亲和性规则不允许 Pod 与现有 Pod 共存。您可以检查 Pod 反亲和性规则是否正确设置，并确保已经部署的 Pod 没有占满可用节点。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">节点存在污点（taint）并且 Pod 没有设置相应的容忍度（toleration）。在这种情况下，您可以尝试在 Pod 的规范中添加 tolerations 字段，以容忍节点的污点。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pod 亲和性规则不允许 Pod 与现有节点共存。您可以检查 Pod 亲和性规则是否正确设置，并确保可用节点符合规则。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">可用节点数量不足。您可以检查集群的资源状况，以确保有足够的节点可用。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="有状态服务和无状态服务">有状态服务和无状态服务<a href="#有状态服务和无状态服务" class="hash-link" aria-label="有状态服务和无状态服务的直接链接" title="有状态服务和无状态服务的直接链接">​</a></h2><p><strong>5.2.1、有状态服务</strong>
有状态服务的工作负载： StatefulSet。
有状态服务可以说是需要数据存储功能的服务、或者指多线程类型的服务，队列等。（mysql 数据库、kafka、zookeeper 等）每个实例都需要有自己独立的持久化存储，并且在 k8s 中是通过申明模板来进行定义。持久卷申明模板在创建 pod 之前创建，绑定到 pod 中，模板可以定义多个。<br>
<!-- -->唯一性: 每个 Pod 会被分配一个唯一序号。<br>
<!-- -->顺序性: Pod 启动，更新，销毁是按顺序进行。<br>
<!-- -->稳定的网络标识: Pod 主机名，DNS 地址不会随着 Pod 被重新调度而发生变化。<br>
<!-- -->稳定的持久化存储: Pod 被重新调度后，仍然能挂载原有的 PV，从而保证了数据的完整性和一致性。<br>
<!-- -->总结：Stateful 有状态服务，每个 Pod 有独立的 PVC/PV 存储组件。  </p><p><strong>5.2.2、无状态服务</strong>
无状态控制器：ReplicaSet、ReplicationController、Deployment。<br>
<!-- -->无状态服务内的多个 Pod 创建的顺序是没有顺序的。创建的 pod 序号都是随机值。并且在缩容的时候并不会明确缩容某一个 pod，而是随机的，因为所有实例得到的返回值都是一样，所以缩容任何一个 pod 都可以。<br>
<!-- -->无状态服务内的多个 Pod 的名称是随机的，pod 被重新启动调度后，它的名称与 IP 都会发生变化。<br>
<!-- -->无状态服务内的多个 Pod 背后是共享存储的，该服务运行的实例不会在本地存储需要持久化的数据。（有冲突？）<br>
<!-- -->多个实例对于同一个请求响应的结果是完全一致的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="重启策略">重启策略<a href="#重启策略" class="hash-link" aria-label="重启策略的直接链接" title="重启策略的直接链接">​</a></h2><p>在 k8s 集群中有如下三种重启策略：
Always：当容器终止退出后，总是重启容器，默认策略。
OnFailure：当容器异常退出（退出状态码非0）时，重启容器。
Never：当容器终止退出，从不重启容器。
重启策略适用于 pod 对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由 kubelet 延迟一段时间后进行，且反复的重启操作的延迟时长为10s，20s，40s，80s，160s，300s，300s 是最大延迟时长。
重启策略设置建议：
因为重启策略默认的是 Always，这也是合理的，因此在一般情况下，重启策略不需要设置，这里仅仅是作为知识点拿出来展示一下，在实际使用中，在大多数情况下都不需要进行重启策略配置。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="污点和容忍度">污点和容忍度<a href="#污点和容忍度" class="hash-link" aria-label="污点和容忍度的直接链接" title="污点和容忍度的直接链接">​</a></h2><p><a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank" rel="noopener noreferrer">污点和容忍度文档</a></p><p><a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity" target="_blank" rel="noopener noreferrer">节点亲和性</a> 是 <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">Pod</a> 的一种属性，它使 Pod 被吸引到一类特定的<a href="https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/" target="_blank" rel="noopener noreferrer">节点</a> （这可能出于一种偏好，也可能是硬性要求）。 <strong>污点（Taint）</strong> 则相反——它使节点能够排斥一类特定的 Pod。
<strong>容忍度（Toleration）</strong> 是应用于 Pod 上的。容忍度允许调度器调度带有对应污点的 Pod。 容忍度允许调度但并不保证调度：作为其功能的一部分， 调度器也会<a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/pod-priority-preemption/" target="_blank" rel="noopener noreferrer">评估其他参数</a>。
污点和容忍度（Toleration）相互配合，可以用来避免 Pod 被分配到不合适的节点上。 每个节点上都可以应用一个或多个污点，这表示对于那些不能容忍这些污点的 Pod， 是不会被该节点接受的。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1、查看集群中所有节点的污点信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe nodes | grep -E &quot;Name:|Taints&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、查看污点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl describe nodes &lt;node 节点名称&gt; |grep Taints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl describe nodes k8s-master |grep Taints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">结果：Taints: node-role.kubernetes.io/master:NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、设置污点 effect=NoSchedule/PreferNoSchedule/NoExecute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl taint nodes &lt;node 节点名称&gt; key=value:effect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl taint nodes &lt;k8s-master&gt; key1=value1:NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、删除污点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命令：kubectl taint node &lt;node 节点名称&gt; &lt;污点名称&gt;- （注：在污点名称后面加上减号）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：kubectl taint node k8s-master gameble-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5、在 Pod 的规范中添加容忍度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tolerations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - key: &quot;key&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operator: &quot;Equal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: &quot;value&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    effect: &quot;NoSchedule&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6、部署时忽略节点的污点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create deployment nginx --image=nginx --ignore-preflight-errors=All</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">踩坑：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">报错1:  Warning  FailedScheduling  32s (x7 over 6m41s)  default-scheduler  0/1 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn&#x27;t tolerate.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">解决1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看污点：kubectl describe nodes k8s-master |grep Taints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">删除污点：kubectl taint nodes --all node-role.kubernetes.io/master:NoSchedule-</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="故障类型">故障类型<a href="#故障类型" class="hash-link" aria-label="故障类型的直接链接" title="故障类型的直接链接">​</a></h2><p>k8s 之连接异常（集群故障）
k8s 之通信异常（网络故障）
k8s 之内部异常（节点异常）
k8s 之应用故障（应用异常）</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pod-和-deployment-区别">Pod 和 Deployment 区别<a href="#pod-和-deployment-区别" class="hash-link" aria-label="Pod 和 Deployment 区别的直接链接" title="Pod 和 Deployment 区别的直接链接">​</a></h2><p>pod 是单一亦或一组容器的合集。
deployment 是 pod 版本管理的工具，用来区分不同版本的 pod。
单独创建 pod 的时候就不会有 deployment 出现，但是创建 deployment 的时候一定会创建 pod,因为 pod 是一个基础的单位。任何的控制器单位的具体实现必须落到 pod 去实现。</p><h1>7. 知识碎片</h1><p><strong>网络诊断：</strong></p><ol><li>显示命名空间中 Pod 的 IP 地址：<code>kubectl get pods -n &lt;namespace&gt; -o custom-columns=POD:metadata.name,IP:status.podIP --no-headers</code></li><li>列出命名空间中的所有网络策略：<code>kubectl get networkpolicies -n &lt;namespace&gt;</code></li><li>查看一个网络策略详情：<code>kubectl describe networkpolicy &lt;network-policy-name&gt; -n &lt;namespace&gt;</code></li></ol><p><strong>节点诊断：</strong></p><ol><li>获取特定节点上运行的 Pod 列表：<code>kubectl get pods --field-selector spec.nodeName=&lt;node-name&gt; -n &lt;namespace&gt;</code></li></ol><p><strong>资源配额和限制：</strong></p><ol><li>列出命名空间中的资源配额：<code>kubectl get resourcequotas -n &lt;namespace&gt;</code></li><li>查看一个资源配额详情：<code>kubectl describe resourcequota &lt;resource-quota-name&gt; -n &lt;namespace&gt;</code></li></ol><p>利用存储的本证书生成 tls 证书 secret：
<code>kubectl create secret tls secret(自定义名字) --key /tmp/nginx.key --cert /tmp/nginx.crt --namespace=my-space</code></p><p>创建 pod 时候不写 namespace 会报错，暂未找到原因，可以在命令后加 <code>--namespace=&lt;namespace 名称&gt;</code></p><p>举例：<code>kubectl run my-pod --image=nginx --namespace=my-namespace</code></p><p>设置别名：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[ ! -f ~/.kube/aliases.sh ] &amp;&amp; curl -fsSL &quot;https://raw.githubusercontent.com/ahmetb/kubectl-aliases/master/.kubectl_aliases&quot; &gt; ~/.kube/aliases.sh &amp;&amp; sed -i -e &#x27;s/kubectl/kctl/g&#x27; ~/.kube/aliases.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source ~/.kube/aliases.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如何验证两个 Pod 的服务是否联通？<br>
<!-- -->进入其中一个 Pod 的容器内部:<br>
<code>kubectl exec -it &lt;pod_name&gt; -- /bin/sh</code></p><p>在容器内部尝试访问另一个 Pod 的服务:<br>
<code>curl http://&lt;other_pod_service_name&gt;:&lt;port&gt;</code></p><p>k8s pod 参数说明</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cpu:     4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memory:  8092Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cpu:     200m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memory:  2Gi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>CPU Limits: 这个 Pod 被限制最多使用 4 个 CPU 核心。也就是说,即使节点上有更多可用的 CPU 资源,这个 Pod 也最多只能使用 4 个 CPU 核心。</li><li>Memory Limits: 这个 Pod 被限制最多使用 8092 Mi (8.092 GB) 的内存。如果 Pod 使用的内存超过这个限制,就会被 Kubernetes 终止。</li><li>CPU Requests: 这个 Pod 声明需要 200 m (0.2) 个 CPU 核心。Kubernetes 会确保调度这个 Pod 到一个至少有 0.2 个 CPU 核心可用的节点上。</li><li>Memory Requests: 这个 Pod 声明需要 2 Gi (2 GB) 的内存。Kubernetes 会确保调度这个 Pod 到一个至少有 2 GB 可用内存的节点上。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="终端登录-k8s">终端登录 k8s<a href="#终端登录-k8s" class="hash-link" aria-label="终端登录 k8s的直接链接" title="终端登录 k8s的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-安装-kubectl">1. 安装 kubectl<a href="#1-安装-kubectl" class="hash-link" aria-label="1. 安装 kubectl的直接链接" title="1. 安装 kubectl的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">下载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">验证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-配置">2. 配置<a href="#2-配置" class="hash-link" aria-label="2. 配置的直接链接" title="2. 配置的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">查看上下文获取&lt;cluster_name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config current-context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：&lt;cluster_name&gt;=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看集群状态获取&lt;cluster_ip&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cluster-info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：&lt;cluster_ip&gt;=127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">获取&lt;username&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config view --minify --output &#x27;jsonpath={..name}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例：&lt;username&gt;=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">获取&lt;token&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s kubectl -n kubernetes-dashboard create token admin-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">获取上下文列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config get-contexts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config set-cluster &lt;cluster_name&gt; --server=https://&lt;cluster_ip&gt;:6443 --insecure-skip-tls-verify=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config set-credentials &lt;username&gt; --token=&lt;token&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config set-context &lt;cluster_name&gt; --user=&lt;username&gt; --cluster=&lt;cluster_name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config use-context &lt;cluster_name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config set-cluster default --server=https://127.0.0.1:6443 --insecure-skip-tls-verify=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config set-credentials default --token=`k3s kubectl -n kubernetes-dashboard create token admin-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config set-context default --user=default --cluster=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config use-context default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看本地 config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat ~/.kube/config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-添加脚本">3. 添加脚本<a href="#3-添加脚本" class="hash-link" aria-label="3. 添加脚本的直接链接" title="3. 添加脚本的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 方式一：vim ~/.bashrc，添加：function 脚本 和 alias=&#x27;pod&#x27; alias=&#x27;log&#x27; 后执行：source ~/.bashrc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 方式二：把 login_k8s.sh 上传到 /etc/profile.d 后执行：source /etc/profile.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function pod() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [ -z &quot;$1&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo -e &quot;\033[32m kubectl get pod -A \033[0m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl get pod -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl config set-context --current --namespace=$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo -e &quot;\033[32m 获取第1个 pod 名称: kubectl get pod -n $1 |grep $2 |awk &#x27;{print \$1}&#x27; |head -n 1 \033[0m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pod_name=`kubectl get pod -n $1 |grep $2 |awk  &#x27;{print \$1}&#x27; |head -n 1`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo -e &quot;\033[32m 进入第1个 pod: kubectl exec -it pod/$pod_name -n $1 -- sh \033[0m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl exec -it pod/$pod_name -n $1 -- sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [ -z &quot;$1&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo -e &quot;\033[32m kubectl get pod -A \033[0m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl get pod -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl config set-context --current --namespace=$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo -e &quot;\033[32m 获取第1个 pod 名称: kubectl get pod -n $1 |grep $2 |awk &#x27;{print \$1}&#x27; |head -n 1 \033[0m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pod_name=`kubectl get pod -n $1 |grep $2 |awk  &#x27;{print \$1}&#x27; |head -n 1`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl logs -f $pod_name -n $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alias pod=&#x27;pod&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alias log=&#x27;log&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Jenkins/Pipeline/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Pipeline</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Kubernetes/Helm"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Helm</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#11-kubernetes-简介" class="table-of-contents__link toc-highlight">1.1 Kubernetes 简介</a></li><li><a href="#12-kubernetes-组件" class="table-of-contents__link toc-highlight">1.2 Kubernetes 组件</a></li><li><a href="#21-kubernetes-搭建mac" class="table-of-contents__link toc-highlight">2.1 Kubernetes 搭建（Mac）</a></li><li><a href="#22-kubernetes-搭建linux" class="table-of-contents__link toc-highlight">2.2 Kubernetes 搭建（Linux）</a></li><li><a href="#31-资源配置" class="table-of-contents__link toc-highlight">3.1 资源配置</a></li><li><a href="#32-资源管理" class="table-of-contents__link toc-highlight">3.2 资源管理</a></li><li><a href="#33-资源类型" class="table-of-contents__link toc-highlight">3.3 资源类型</a></li><li><a href="#kubectl" class="table-of-contents__link toc-highlight">kubectl</a></li><li><a href="#namespace" class="table-of-contents__link toc-highlight">Namespace</a></li><li><a href="#pod-资源" class="table-of-contents__link toc-highlight">pod 资源</a><ul><li><a href="#pods" class="table-of-contents__link toc-highlight">Pods</a></li></ul></li><li><a href="#pod-资源控制器" class="table-of-contents__link toc-highlight">pod 资源控制器</a><ul><li><a href="#deployment" class="table-of-contents__link toc-highlight">Deployment</a></li><li><a href="#replication-controller" class="table-of-contents__link toc-highlight">Replication Controller</a></li><li><a href="#replicaset" class="table-of-contents__link toc-highlight">ReplicaSet</a></li><li><a href="#statefulset" class="table-of-contents__link toc-highlight">StatefulSet</a></li><li><a href="#daemonset" class="table-of-contents__link toc-highlight">DaemonSet</a></li></ul></li><li><a href="#服务发现资源" class="table-of-contents__link toc-highlight">服务发现资源</a><ul><li><a href="#service" class="table-of-contents__link toc-highlight">Service</a></li><li><a href="#ingress" class="table-of-contents__link toc-highlight">Ingress</a></li></ul></li><li><a href="#存储资源" class="table-of-contents__link toc-highlight">存储资源</a><ul><li><a href="#persistentvolume" class="table-of-contents__link toc-highlight">PersistentVolume</a></li><li><a href="#storageclass" class="table-of-contents__link toc-highlight">storageclass</a></li></ul></li><li><a href="#配置资源" class="table-of-contents__link toc-highlight">配置资源</a><ul><li><a href="#configmap" class="table-of-contents__link toc-highlight">ConfigMap</a></li><li><a href="#secret" class="table-of-contents__link toc-highlight">Secret</a></li></ul></li><li><a href="#其它" class="table-of-contents__link toc-highlight">其它</a><ul><li><a href="#poddisruptionbudget" class="table-of-contents__link toc-highlight">PodDisruptionBudget</a></li><li><a href="#podsecuritypolicy" class="table-of-contents__link toc-highlight">PodSecurityPolicy</a></li><li><a href="#label" class="table-of-contents__link toc-highlight">Label</a></li><li><a href="#job" class="table-of-contents__link toc-highlight">Job</a></li><li><a href="#event" class="table-of-contents__link toc-highlight">Event</a></li><li><a href="#metrics-server" class="table-of-contents__link toc-highlight">metrics-server</a></li><li><a href="#crd" class="table-of-contents__link toc-highlight">CRD</a></li><li><a href="#scheduler" class="table-of-contents__link toc-highlight">Scheduler</a></li><li><a href="#etcd" class="table-of-contents__link toc-highlight">Etcd</a></li><li><a href="#pull-secret" class="table-of-contents__link toc-highlight">Pull Secret</a></li><li><a href="#cadvisor" class="table-of-contents__link toc-highlight">cAdvisor</a></li></ul></li><li><a href="#亲和性和反亲和性" class="table-of-contents__link toc-highlight">亲和性和反亲和性</a></li><li><a href="#有状态服务和无状态服务" class="table-of-contents__link toc-highlight">有状态服务和无状态服务</a></li><li><a href="#重启策略" class="table-of-contents__link toc-highlight">重启策略</a></li><li><a href="#污点和容忍度" class="table-of-contents__link toc-highlight">污点和容忍度</a></li><li><a href="#故障类型" class="table-of-contents__link toc-highlight">故障类型</a></li><li><a href="#pod-和-deployment-区别" class="table-of-contents__link toc-highlight">Pod 和 Deployment 区别</a></li><li><a href="#终端登录-k8s" class="table-of-contents__link toc-highlight">终端登录 k8s</a><ul><li><a href="#1-安装-kubectl" class="table-of-contents__link toc-highlight">1. 安装 kubectl</a></li><li><a href="#2-配置" class="table-of-contents__link toc-highlight">2. 配置</a></li><li><a href="#3-添加脚本" class="table-of-contents__link toc-highlight">3. 添加脚本</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5e310ca4.js"></script>
<script src="/assets/js/main.cb284e89.js"></script>
</body>
</html>